# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
services:
  ubuntu-cpp-dev:
    # Usage:
    #   docker compose build ubuntu-cpp-dev
    #   podman compose build ubuntu-cpp-dev
    image: docker.io/presto/presto-cpp-dev:ubuntu-22.04
    build:
      args:
        - DEPENDENCY_IMAGE=presto/prestissimo-dependency:ubuntu-22.04
        - BASE_IMAGE=ubuntu:22.04
        - OSNAME=ubuntu
        - ARM_BUILD_TARGET=notlocal
        - EXTRA_CMAKE_FLAGS=-DPRESTO_ENABLE_TESTING=OFF
                            -DPRESTO_ENABLE_PARQUET=ON
                            -DPRESTO_ENABLE_S3=ON
                            -DPRESTO_ENABLE_REMOTE_FUNCTIONS=ON
                            -DPRESTO_ENABLE_JWT=ON
                            -DPRESTO_STATS_REPORTER_TYPE=PROMETHEUS
                            -DPRESTO_MEMORY_CHECKER_TYPE=LINUX_MEMORY_CHECKER
                            -DPRESTO_ENABLE_SPATIAL=ON
                            -DVELOX_BUILD_TESTING=OFF
                            -DVELOX_ENABLE_SPARK=ON
                            -DVELOX_ENABLE_SPARK_FUNCTIONS=ON
      context: ..
      dockerfile: presto-dev/Dockerfile-cpp-dev
      labels:
        org.opencontainers.image.revision: ${COMMIT_ID}
        org.opencontainers.image.created: ${TIMESTAMP}
        org.opencontainers.image.version: ${VERSION}
        org.opencontainers.image.description: ${DESCRIPTION}
        org.opencontainers.image.licenses: Apache-2.0

  centos-cpp-dev:
    # Usage:
    #   docker compose build centos-cpp-dev
    #   podman compose build centos-cpp-dev
    image: docker.io/presto/presto-cpp-dev:centos9
    build:
      args:
        - DEPENDENCY_IMAGE=presto/prestissimo-dependency:centos9
        - ARM_BUILD_TARGET=notlocal
        - EXTRA_CMAKE_FLAGS=-DPRESTO_ENABLE_TESTING=ON
                            -DPRESTO_ENABLE_PARQUET=ON
                            -DPRESTO_ENABLE_S3=ON
                            -DPRESTO_ENABLE_REMOTE_FUNCTIONS=ON
                            -DPRESTO_ENABLE_JWT=ON
                            -DPRESTO_STATS_REPORTER_TYPE=PROMETHEUS
                            -DPRESTO_MEMORY_CHECKER_TYPE=LINUX_MEMORY_CHECKER
                            -DPRESTO_ENABLE_SPATIAL=ON
                            -DVELOX_BUILD_TESTING=OFF
                            -DVELOX_ENABLE_SPARK=ON
                            -DVELOX_ENABLE_SPARK_FUNCTIONS=ON
      context: ..
      dockerfile: presto-dev/Dockerfile-cpp-dev
      labels:
        org.opencontainers.image.revision: ${COMMIT_ID}
        org.opencontainers.image.created: ${TIMESTAMP}
        org.opencontainers.image.version: ${VERSION}
        org.opencontainers.image.description: ${DESCRIPTION}
        org.opencontainers.image.licenses: Apache-2.0

  ubuntu-java-dev:
    # Usage:
    #   docker compose build ubuntu-java-dev
    #   podman compose build ubuntu-java-dev
    image: docker.io/presto/presto-java-dev:ubuntu-22.04
    build:
      context: ..
      args:
        - BASE_IMAGE=presto/presto-cpp-dev:ubuntu-22.04
      dockerfile: presto-dev/Dockerfile-java-dev
      target: ubuntu
      labels:
        org.opencontainers.image.revision: ${COMMIT_ID}
        org.opencontainers.image.created: ${TIMESTAMP}
        org.opencontainers.image.version: ${VERSION}
        org.opencontainers.image.description: ${DESCRIPTION}
        org.opencontainers.image.licenses: Apache-2.0

  centos-java-dev:
    # Usage:
    #   docker compose build centos-dev
    #   podman compose build centos-dev
    #   docker compose run --rm -it --service-ports centos-dev
    #   podman compose run --rm -it --service-ports centos-dev
    image: docker.io/presto/presto-java-dev:centos9
    build:
      args:
        - BASE_IMAGE=presto/presto-cpp-dev:centos9
      context: ..
      dockerfile: presto-dev/Dockerfile-java-dev
      target: centos
      labels:
        org.opencontainers.image.revision: ${COMMIT_ID}
        org.opencontainers.image.created: ${TIMESTAMP}
        org.opencontainers.image.version: ${VERSION}
        org.opencontainers.image.description: ${DESCRIPTION}
        org.opencontainers.image.licenses: Apache-2.0

  ubuntu-dev:
    # Usage:
    #   docker compose build ubuntu-dev
    #   podman compose build ubuntu-dev
    #   docker compose run --rm -it --service-ports ubuntu-dev
    #   podman compose run --rm -it --service-ports ubuntu-dev
    image: docker.io/presto/presto-dev:ubuntu-22.04
    build:
      args:
        - BASE_IMAGE=presto/presto-java-dev:ubuntu-22.04
      dockerfile: Dockerfile-tools
      target: ubuntu
      labels:
        org.opencontainers.image.revision: ${COMMIT_ID}
        org.opencontainers.image.created: ${TIMESTAMP}
        org.opencontainers.image.version: ${VERSION}
        org.opencontainers.image.description: ${DESCRIPTION}
        org.opencontainers.image.licenses: Apache-2.0
    stdin_open: true
    tty: true
    volumes:
      - ..:/presto
      - ./root:/root
      - ./presto/etc:/opt/presto/etc
      - ./presto/data:/opt/presto/data
      - ./prestissimo/etc:/opt/prestissimo/etc
    working_dir: /presto/presto-native-execution
    ports:
    - 8080:8080
    - 7777:7777
    - 2222:2222
    command: /usr/sbin/sshd -D

  centos-dev:
    # Usage:
    #   docker compose build centos-dev
    #   podman compose build centos-dev
    #   docker compose run --rm -it --service-ports centos-dev
    #   podman compose run --rm -it --service-ports centos-dev
    image: docker.io/presto/presto-dev:centos9
    build:
      args:
        - BASE_IMAGE=presto/presto-java-dev:centos9
      dockerfile: Dockerfile-tools
      target: centos
      labels:
        org.opencontainers.image.revision: ${COMMIT_ID}
        org.opencontainers.image.created: ${TIMESTAMP}
        org.opencontainers.image.version: ${VERSION}
        org.opencontainers.image.description: ${DESCRIPTION}
        org.opencontainers.image.licenses: Apache-2.0
    stdin_open: true
    tty: true
    volumes:
      - ..:/presto
      - ./root:/root
      - ./presto/etc:/opt/presto/etc
      - ./presto/data:/opt/presto/data
      - ./prestissimo/etc:/opt/prestissimo/etc
    working_dir: /presto/presto-native-execution
    ports:
    - 8080:8080
    - 7777:7777
    - 2222:2222
    command: /usr/sbin/sshd -D
